<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pmultiqc - PRIDE Dataset Analysis</title>
    <link rel="stylesheet" href="{{ config.BASE_URL.rstrip('/') }}/static/style.css">
    <link rel="stylesheet" href="{{ config.BASE_URL.rstrip('/') }}/static/components.css">
</head>
<body>
    <div class="container">
        <div class="logo">pmultiqc</div>
        <div class="subtitle">Proteomics MultiQC Analysis</div>

        {% if error %}
        <div class="error-message">
            {{ error }}
        </div>
        <div class="home-link">
            <a href="{{ config.BASE_URL.rstrip('/') }}/">‚Üê Return to Home</a>
        </div>
        {% else %}
        <div class="accession-display">
            <div>PRIDE Dataset:</div>
            <div class="accession-code">{{ accession }}</div>
        </div>

        <div class="description">
            This will analyze the PRIDE dataset using pmultiqc to generate quality control reports for proteomics data.
            The analysis will process search engine output files and create comprehensive quality metrics.
        </div>

        <!-- Progress Section (initially hidden) -->
        <div id="progressSection" style="display: none; margin: 30px 0;">
            <h3 id="progressTitle">‚è≥ Processing PRIDE Dataset...</h3>
            
            <!-- Progress Bar -->
            <div class="progress-container" style="margin: 20px 0;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%; background: linear-gradient(45deg, #007bff, #0056b3);"></div>
                </div>
                <div id="progressText" class="progress-text">Initializing...</div>
            </div>
            
            <!-- Status Details -->
            <div id="statusDetails" style="
                background: #f8f9fa; 
                border: 1px solid #e9ecef; 
                border-radius: 8px; 
                padding: 15px; 
                margin: 15px 0;
                font-size: 14px;
            ">
                <div id="currentStage" style="font-weight: bold; color: #007bff; margin-bottom: 10px;">
                    üöÄ Starting analysis...
                </div>
                <div id="stageDetails" style="color: #666; font-size: 13px;">
                    Preparing to fetch files from PRIDE database...
                </div>
                
                <!-- Download Progress Details (initially hidden) -->
                <div id="downloadProgressDetails" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <div style="font-weight: bold; color: #28a745; margin-bottom: 8px;">üì• Download Progress</div>
                    <div id="downloadFileInfo" style="color: #495057; font-size: 12px; margin-bottom: 8px;">
                        <span id="currentFileName">-</span>
                    </div>
                    <div id="downloadProgressBar" style="
                        width: 100%; 
                        height: 8px; 
                        background-color: #e9ecef; 
                        border-radius: 4px; 
                        overflow: hidden; 
                        margin: 8px 0;
                    ">
                        <div id="downloadProgressFill" style="
                            height: 100%; 
                            background: linear-gradient(45deg, #28a745, #20c997); 
                            width: 0%; 
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                    <div id="downloadStats" style="
                        display: flex; 
                        justify-content: space-between; 
                        font-size: 11px; 
                        color: #6c757d;
                        margin-top: 5px;
                    ">
                        <span id="downloadBytes">0 B / 0 B</span>
                        <span id="downloadSpeed">0 B/s</span>
                        <span id="downloadEta">ETA: --</span>
                    </div>
                </div>
            </div>
            
            <!-- Console Output Section -->
            <div id="consoleOutputSection" style="display: none; margin-top: 20px;">
                <h4 style="color: #495057; margin-bottom: 10px;">üìã Console Output</h4>
                <div id="consoleOutput" style="
                    background: #f8f9fa; 
                    border: 1px solid #e9ecef; 
                    border-radius: 8px; 
                    padding: 15px; 
                    font-family: 'Courier New', monospace; 
                    font-size: 12px; 
                    max-height: 300px; 
                    overflow-y: auto; 
                    white-space: pre-wrap; 
                    color: #333;
                    line-height: 1.4;
                "></div>
            </div>
        </div>

        <button id="submitBtn" class="submit-btn" onclick="submitPrideDataset()">
            Start Analysis
        </button>

        <div class="home-link">
            <a href="{{ config.BASE_URL.rstrip('/') }}/">‚Üê Return to Home</a>
        </div>
        {% endif %}

        <!-- pmultiqc Information Footer -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); margin-top: 40px; padding: 30px; border-top: 3px solid #007bff; border-radius: 0 0 15px 15px; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto;">
            <div style="text-align: center;">
            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">About pmultiqc</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 25px; font-size: 1.1em;">
                <strong>pmultiqc</strong> is a MultiQC plugin for comprehensive quality control reporting of proteomics data. 
                It generates interactive HTML reports with visualizations and metrics to help you assess the quality of 
                your mass spectrometry-based proteomics experiments.
            </p>
            
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                <a href="https://pmultiqc.quantms.org" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #007bff, #0056b3); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,123,255,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üåê Project Website
                </a>
                
                <a href="https://github.com/bigbio/pmultiqc" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #28a745, #20c997); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(40,167,69,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üìÇ GitHub Repository
                </a>
                
                <a href="https://pmultiqc.quantms.org/#-example-reports" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #6f42c1, #5a32a3); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(111,66,193,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üìä Example Reports
                </a>
            </div>
            
            <div style="border-top: 1px solid #dee2e6; padding-top: 20px;">
                <p style="color: #6c757d; font-size: 0.9em; margin: 0;">
                    Powered by <strong>pmultiqc</strong> - A comprehensive proteomics quality control framework
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global configuration - can be overridden by environment
        window.APP_CONFIG = {
            BASE_URL: '{{ config.BASE_URL.rstrip("/") }}',
            API_BASE: '{{ config.BASE_URL.rstrip("/") }}'
        };
        
        // Function to get full URL for API endpoints
        function getApiUrl(endpoint) {
            console.log('getApiUrl', endpoint);
            return `${window.APP_CONFIG.API_BASE}${endpoint}`;
        }
        
        // Function to get full URL for static assets
        function getAssetUrl(asset) {
            return `${window.APP_CONFIG.BASE_URL}/static/${asset}`;
        }
        
        let currentJobId = null;
        let progressInterval = null;

        // Stage descriptions for better user experience
        const stageDescriptions = {
            'queued': 'üöÄ Starting analysis...',
            'fetching_files': 'üîç Fetching files from PRIDE database...',
            'filtering_files': 'üîç Filtering search engine output files...',
            'downloading_files': 'üì• Downloading files from PRIDE...',
            'extracting_files': 'üì¶ Extracting and processing files...',
            'processing': '‚öôÔ∏è Running pmultiqc analysis...',
            'completed': '‚úÖ Analysis completed successfully!',
            'failed': '‚ùå Analysis failed'
        };

        // Helper function to format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Helper function to format speed
        function formatSpeed(bytesPerSecond) {
            return formatBytes(bytesPerSecond) + '/s';
        }

        // Helper function to format time
        function formatTime(seconds) {
            if (!isFinite(seconds) || isNaN(seconds) || seconds <= 0) return '--';
            if (seconds < 60) return Math.round(seconds) + 's';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);
            return minutes + 'm ' + remainingSeconds + 's';
        }

        async function submitPrideDataset() {
            const submitBtn = document.getElementById('submitBtn');
            const progressSection = document.getElementById('progressSection');

            // Hide button and show progress
            submitBtn.style.display = 'none';
            progressSection.style.display = 'block';

            try {
                const response = await fetch(getApiUrl('/submit-pride'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        accession: '{{ accession }}'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    currentJobId = data.job_id;
                    console.log('PRIDE job started with ID:', currentJobId);
                    
                    // Start polling for progress
                    startProgressPolling();
                } else {
                    showError(data.error || 'Failed to start analysis');
                    resetButton();
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                resetButton();
            }
        }

        function startProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(getApiUrl(`/job-status/${currentJobId}`));
                    const data = await response.json();

                    if (response.ok) {
                        console.log('Job status:', data.status, 'Progress:', data.progress);
                        
                        updateProgress(data);
                        
                        if (data.status === 'completed' || data.status === 'failed') {
                            clearInterval(progressInterval);
                            showResults(data);
                        }
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        function updateProgress(data) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const currentStage = document.getElementById('currentStage');
            const stageDetails = document.getElementById('stageDetails');
            const consoleOutput = document.getElementById('consoleOutput');
            const consoleOutputSection = document.getElementById('consoleOutputSection');
            const downloadProgressDetails = document.getElementById('downloadProgressDetails');

            // Update progress bar
            if (data.progress !== undefined) {
                progressFill.style.width = data.progress + '%';
                progressText.textContent = `Progress: ${data.progress}%`;
            }

            // Update stage information
            const stageDesc = stageDescriptions[data.status] || data.status;
            currentStage.textContent = stageDesc;

            // Update stage details
            let details = '';
            if (data.status === 'downloading_files' && data.files_downloaded !== undefined) {
                details = `Downloaded ${data.files_downloaded} files...`;
            } else if (data.status === 'processing' && data.files_processed !== undefined) {
                details = `Processed ${data.files_processed} of ${data.total_files} files...`;
            } else if (data.processing_stage) {
                details = data.processing_stage;
            } else {
                details = 'Processing...';
            }
            stageDetails.textContent = details;

            // Update download progress details if available
            if (data.status === 'downloading_files' && data.download_details) {
                const downloadDetails = data.download_details;
                downloadProgressDetails.style.display = 'block';
                
                // Update current file name
                const currentFileName = document.getElementById('currentFileName');
                currentFileName.textContent = downloadDetails.current_file || 'Unknown file';
                
                // Update download progress bar
                const downloadProgressFill = document.getElementById('downloadProgressFill');
                if (downloadDetails.total_bytes > 0) {
                    const downloadPercent = (downloadDetails.downloaded_bytes / downloadDetails.total_bytes) * 100;
                    downloadProgressFill.style.width = downloadPercent + '%';
                }
                
                // Update download statistics
                const downloadBytes = document.getElementById('downloadBytes');
                const downloadSpeed = document.getElementById('downloadSpeed');
                const downloadEta = document.getElementById('downloadEta');
                
                downloadBytes.textContent = `${formatBytes(downloadDetails.downloaded_bytes)} / ${formatBytes(downloadDetails.total_bytes)}`;
                downloadSpeed.textContent = formatSpeed(downloadDetails.speed_bytes_per_sec || 0);
                downloadEta.textContent = `ETA: ${formatTime(downloadDetails.eta_seconds)}`;
            } else {
                // Hide download progress details for other stages
                downloadProgressDetails.style.display = 'none';
            }

            // Update console output
            if (data.console_output && data.console_output.length > 0) {
                consoleOutputSection.style.display = 'block';
                updateConsoleOutput(data.console_output, data.console_errors || []);
            }

            // Update title based on status
            const progressTitle = document.getElementById('progressTitle');
            if (data.status === 'completed') {
                progressTitle.textContent = '‚úÖ Analysis Complete!';
                progressTitle.style.color = '#28a745';
            } else if (data.status === 'failed') {
                progressTitle.textContent = '‚ùå Analysis Failed';
                progressTitle.style.color = '#dc3545';
            }
        }

        function updateConsoleOutput(consoleOutput, consoleErrors) {
            const consoleDiv = document.getElementById('consoleOutput');
            if (!consoleDiv) return;
            
            // Clear existing content and add all output
            consoleDiv.innerHTML = '';
            
            // Add output lines
            consoleOutput.forEach(line => {
                if (line.trim()) {
                    const lineDiv = document.createElement('div');
                    lineDiv.style.margin = '2px 0';
                    lineDiv.style.color = '#2e8b57'; // Green for output
                    lineDiv.textContent = '> ' + line;
                    consoleDiv.appendChild(lineDiv);
                }
            });
            
            // Add error lines
            consoleErrors.forEach(line => {
                if (line.trim()) {
                    const lineDiv = document.createElement('div');
                    lineDiv.style.margin = '2px 0';
                    lineDiv.style.color = '#dc3545'; // Red for errors
                    lineDiv.style.fontWeight = 'bold';
                    lineDiv.textContent = '! ' + line;
                    consoleDiv.appendChild(lineDiv);
                }
            });
            
            // Auto-scroll to bottom
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function showResults(data) {
            console.log('Submit results data:', data);
            console.log('Current job ID:', currentJobId);
            console.log('Redirecting to:', `${window.APP_CONFIG.BASE_URL}/results?job=${currentJobId}`);
            
            // Redirect to the results page instead of showing results inline
            window.location.href = `${window.APP_CONFIG.BASE_URL}/results?job=${currentJobId}`;
        }

        function showError(message) {
            const submitBtn = document.getElementById('submitBtn');
            const progressSection = document.getElementById('progressSection');
            
            // Show button and hide progress
            submitBtn.style.display = 'inline-block';
            progressSection.style.display = 'none';
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Start Analysis';
            
            // Show error message below the button
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<h3>‚ùå Error</h3><p>${message}</p>`;
            errorDiv.style.marginTop = '20px';
            errorDiv.style.padding = '15px';
            errorDiv.style.backgroundColor = '#f8d7da';
            errorDiv.style.border = '1px solid #f5c6cb';
            errorDiv.style.borderRadius = '8px';
            errorDiv.style.color = '#721c24';
            
            // Remove any existing error message
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Insert error message after the button
            submitBtn.parentNode.insertBefore(errorDiv, submitBtn.nextSibling);
        }

        function resetButton() {
            const submitBtn = document.getElementById('submitBtn');
            const progressSection = document.getElementById('progressSection');
            
            submitBtn.style.display = 'inline-block';
            progressSection.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Start Analysis';
        }

        function viewSelectedReport() {
            const selector = document.getElementById('reportSelector');
            const url = selector.value;
            window.open(url, '_blank');
        }
    </script>
</body>
</html> 