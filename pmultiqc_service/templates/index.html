<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMultiQC - Proteomics MultiQC Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='components.css') }}">
</head>
<body>
    <div class="container">
        <div class="logo">PMultiQC</div>
        <div class="subtitle">Proteomics MultiQC Analysis</div>

        <!-- Step 1: Choose Analysis Type -->
        <div id="step1" class="step active">
            <h3>üîç Choose Analysis Type</h3>
            <p>Select how you want to analyze your proteomics data</p>
            <button class="upload-btn" onclick="showStep('upload')">üìÅ Upload Files</button>
            <button class="upload-btn" onclick="showStep('pride')">üîç PRIDE Dataset</button>
            <button class="upload-btn" onclick="showStep('status')">üìä Check Job Status</button>
        </div>

        <!-- Step 2: File Upload -->
        <div id="step2-upload" class="step">
            <h3>üìÅ Upload Files</h3>
            <p>Upload your proteomics data files as ZIP archives (containing MaxQuant, DIANN, quantms, or mzIdentML data)</p>
            <input type="file" id="fileInput" class="file-input" multiple accept=".zip">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose Files</button>
            <div id="fileList"></div>
            <button class="return-home-btn" onclick="returnToHome()">‚Üê Back to Home</button>
        </div>

        <!-- Step 3: PRIDE Dataset -->
        <div id="step2-pride" class="step">
            <h3>üîç PRIDE Dataset Analysis</h3>
            <p>Analyze public PRIDE datasets by entering the accession number</p>
            <input type="text" id="prideAccession" class="pride-input" placeholder="Enter PRIDE accession (e.g., PXD003133)" maxlength="20">
            <button class="process-btn" onclick="processPrideDataset()">Process PRIDE Dataset</button>
            <button class="return-home-btn" onclick="returnToHome()">‚Üê Back to Home</button>
        </div>

        <!-- Step 4: Job Status -->
        <div id="step2-status" class="step">
            <h3>üìä Check Job Status</h3>
            <p>Enter a job ID to check the status of a previous analysis</p>
            <input type="text" id="jobId" class="status-input" placeholder="Enter Job ID">
            <button class="check-btn" onclick="checkStatus()">Check Status</button>
            <button class="check-btn" onclick="debugJobStatus()" style="background: #ffc107; color: #000;">Debug Status</button>
            <button class="return-home-btn" onclick="returnToHome()">‚Üê Back to Home</button>
        </div>

        <!-- Step 5: Progress -->
        <div id="step5" class="step">
            <h3 id="progressTitle">‚è≥ Processing...</h3>
            
            <!-- Upload Progress Section -->
            <div id="uploadProgressSection" style="margin-bottom: 20px;">
                <h4 style="color: #495057; margin-bottom: 10px;">üìÅ File Upload</h4>
                <div id="progressContainer" class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" class="progress-text">Starting processing...</div>
                    <button id="cancelUploadBtn" class="return-home-btn" style="display: none; margin-top: 15px;" onclick="cancelUpload()">‚ùå Cancel Upload</button>
                </div>
            </div>
            
            <!-- Processing Progress Section -->
            <div id="processingProgressSection" style="display: none; margin-bottom: 20px;">
                <h4 style="color: #495057; margin-bottom: 10px;">‚öôÔ∏è PMultiQC Analysis</h4>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="processingProgressFill" class="progress-fill" style="background: linear-gradient(45deg, #28a745, #20c997);"></div>
                    </div>
                    <div id="processingProgressText" class="progress-text">Starting pmultiqc analysis...</div>
                </div>
            </div>
            
            <!-- Console Output Section -->
            <div id="consoleOutputSection" style="display: none;">
                <h4 style="color: #495057; margin-bottom: 10px;">üìã Console Output</h4>
                <div id="consoleOutput" style="
                    background: #f8f9fa; 
                    border: 1px solid #e9ecef; 
                    border-radius: 8px; 
                    padding: 15px; 
                    font-family: 'Courier New', monospace; 
                    font-size: 12px; 
                    max-height: 300px; 
                    overflow-y: auto; 
                    white-space: pre-wrap; 
                    color: #333;
                    line-height: 1.4;
                "></div>
            </div>
        </div>

        <!-- Results -->
        <div id="result" class="result"></div>

        <!-- pmultiqc Information Footer -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); margin-top: 40px; padding: 30px; border-top: 3px solid #007bff; border-radius: 0 0 15px 15px; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto;">
            <div style="text-align: center;">
            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">About PMultiQC</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 25px; font-size: 1.1em;">
                <strong>pmultiqc</strong> is a MultiQC plugin for comprehensive quality control reporting of proteomics data. 
                It generates interactive HTML reports with visualizations and metrics to help you assess the quality of 
                your mass spectrometry-based proteomics experiments.
            </p>
            
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                <a href="https://pmultiqc.quantms.org" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #007bff, #0056b3); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,123,255,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üåê Project Website
                </a>
                
                <a href="https://github.com/bigbio/pmultiqc" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #28a745, #20c997); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(40,167,69,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üìÇ GitHub Repository
                </a>
                
                <a href="https://pmultiqc.quantms.org/#-example-reports" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #6f42c1, #5a32a3); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(111,66,193,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üìä Example Reports
                </a>
            </div>
            
            <div style="border-top: 1px solid #dee2e6; padding-top: 20px;">
                <p style="color: #6c757d; font-size: 0.9em; margin: 0;">
                    Powered by <strong>PMultiQC</strong> - A comprehensive proteomics quality control framework
                </p>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="report-modal">
        <div class="report-modal-content">
            <div class="report-modal-header">
                <h3 class="report-modal-title">PRIDE Report</h3>
                <button class="report-modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="report-modal-body">
                <div id="reportLoading" class="report-modal-loading">Loading report...</div>
                <iframe id="reportIframe" class="report-modal-iframe" style="display: none;" onload="hideLoading()"></iframe>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let processingInProgress = false;
        let currentUploadXhr = null;

        // Wizard navigation
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            // Show selected step
            if (step === 'upload') {
                document.getElementById('step2-upload').classList.add('active');
            } else if (step === 'pride') {
                document.getElementById('step2-pride').classList.add('active');
            } else if (step === 'status') {
                document.getElementById('step2-status').classList.add('active');
            }
        }

        function showProgress() {
            processingInProgress = true;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step5').classList.add('active');
            document.getElementById('progressContainer').style.display = 'block';
        }

        function returnToHome() {
            processingInProgress = false;
            currentJobId = null;
            currentUploadXhr = null;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
            document.getElementById('result').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('cancelUploadBtn').style.display = 'none';
            
            // Reset progress sections
            document.getElementById('processingProgressSection').style.display = 'none';
            document.getElementById('consoleOutputSection').style.display = 'none';
            document.getElementById('progressTitle').textContent = '‚è≥ Processing...';
            document.getElementById('consoleOutput').innerHTML = '';
            
            // Reset progress bars
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('processingProgressFill').style.width = '0%';
            
            // Reset form fields
            document.getElementById('fileInput').value = '';
            document.getElementById('prideAccession').value = '';
            document.getElementById('jobId').value = '';
            document.getElementById('fileList').innerHTML = '';
        }

        function cancelUpload() {
            if (currentUploadXhr) {
                currentUploadXhr.abort();
                currentUploadXhr = null;
            }
            processingInProgress = false;
            document.getElementById('cancelUploadBtn').style.display = 'none';
            showError('Upload cancelled by user');
        }

        // File upload functionality
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = e.target.files;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            for (let file of files) {
                const div = document.createElement('div');
                div.textContent = file.name;
                div.style.margin = '5px 0';
                div.style.padding = '5px';
                div.style.background = '#e9ecef';
                div.style.borderRadius = '4px';
                fileList.appendChild(div);
            }
            
            if (files.length > 0) {
                uploadFiles(files);
            }
        });

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond) {
            return formatBytes(bytesPerSecond) + '/s';
        }

        function formatTime(seconds) {
            if (!isFinite(seconds) || isNaN(seconds) || seconds <= 0) return 'calculating...';
            if (seconds < 60) return Math.round(seconds) + 's';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);
            return minutes + 'm ' + remainingSeconds + 's';
        }

        function uploadFiles(files) {
            if (processingInProgress) return;
            
            console.log('Starting file upload with', files.length, 'files');
            
            const formData = new FormData();
            let totalSize = 0;
            for (let file of files) {
                formData.append('files', file);
                totalSize += file.size;
                console.log('Added file to form data:', file.name, formatBytes(file.size));
            }

            showProgress();
            
            // Initialize progress display
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            progressText.innerHTML = `Preparing to upload ${formatBytes(totalSize)}...`;
            progressFill.style.width = '0%';

            // Track upload timing
            const startTime = Date.now();
            
            // Use XMLHttpRequest for upload progress tracking
            const xhr = new XMLHttpRequest();
            currentUploadXhr = xhr; // Store for potential cancellation
            
            // Show cancel button
            document.getElementById('cancelUploadBtn').style.display = 'inline-block';
            
            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    const elapsed = (Date.now() - startTime) / 1000; // seconds
                    const uploadedMB = e.loaded;
                    const totalMB = e.total;
                    
                    // Update progress bar
                    progressFill.style.width = percentComplete + '%';
                    
                    // Calculate speed and ETA (only if enough time has elapsed)
                    let speedText = 'calculating...';
                    let etaText = 'calculating...';
                    
                    if (elapsed > 0.5 && uploadedMB > 0) { // Wait at least 500ms for stable calculation
                        const speed = uploadedMB / elapsed; // bytes per second
                        const remaining = e.total - e.loaded;
                        const eta = remaining / speed; // seconds
                        
                        speedText = formatSpeed(speed);
                        etaText = formatTime(eta);
                    }
                    
                    // Update progress text with detailed info
                    progressText.innerHTML = `
                        <div>Uploading: ${percentComplete.toFixed(1)}% complete</div>
                        <div style="font-size: 0.8em; margin-top: 5px;">
                            ${formatBytes(uploadedMB)} / ${formatBytes(totalMB)} ‚Ä¢ 
                            ${speedText} ‚Ä¢ 
                            ETA: ${etaText}
                        </div>
                    `;
                    
                    console.log(`Upload progress: ${percentComplete.toFixed(1)}% (${formatBytes(uploadedMB)}/${formatBytes(totalMB)})`);
                }
            });
            
            // Handle upload completion
            xhr.addEventListener('load', function() {
                // Hide cancel button and clear xhr reference
                document.getElementById('cancelUploadBtn').style.display = 'none';
                currentUploadXhr = null;
                
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        console.log('Upload response data:', data);
                        
                        if (data.job_id) {
                            currentJobId = data.job_id;
                            const uploadTime = (Date.now() - startTime) / 1000;
                            
                            // Update upload section to show completion
                            progressText.innerHTML = `
                                <div>‚úÖ Upload completed in ${formatTime(uploadTime)}</div>
                                <div style="font-size: 0.8em; margin-top: 5px; color: #28a745;">
                                    ${formatBytes(totalSize)} uploaded successfully
                                </div>
                            `;
                            progressFill.style.width = '100%';
                            
                            // Show processing section
                            document.getElementById('processingProgressSection').style.display = 'block';
                            document.getElementById('consoleOutputSection').style.display = 'block';
                            
                            // Update title
                            document.getElementById('progressTitle').textContent = '‚öôÔ∏è Running PMultiQC Analysis...';
                            
                            // Start polling for processing status
                            setTimeout(() => {
                                pollStatus(data.job_id);
                            }, 1000);
                        } else {
                            showError(data.error || 'Upload failed');
                        }
                    } catch (e) {
                        console.error('Error parsing response:', e);
                        showError('Upload failed: Invalid server response');
                    }
                } else {
                    console.error('Upload failed with status:', xhr.status);
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        showError('Upload failed: ' + (errorData.error || xhr.statusText));
                    } catch (e) {
                        showError('Upload failed: ' + xhr.statusText);
                    }
                }
            });
            
            // Handle upload errors
            xhr.addEventListener('error', function() {
                // Hide cancel button and clear xhr reference
                document.getElementById('cancelUploadBtn').style.display = 'none';
                currentUploadXhr = null;
                console.error('Upload error occurred');
                showError('Upload failed: Network error');
            });
            
            // Handle upload abort
            xhr.addEventListener('abort', function() {
                // Hide cancel button and clear xhr reference
                document.getElementById('cancelUploadBtn').style.display = 'none';
                currentUploadXhr = null;
                console.log('Upload aborted');
                showError('Upload was cancelled');
            });
            
            // Start the upload
            xhr.open('POST', '/upload-async');
            xhr.send(formData);
        }

        // PRIDE dataset processing
        function processPrideDataset() {
            if (processingInProgress) return;
            
            const accession = document.getElementById('prideAccession').value.trim().toUpperCase();
            
            if (!accession) {
                showError('Please enter a PRIDE accession number');
                return;
            }
            
            if (!accession.startsWith('PXD')) {
                showError('Invalid PRIDE accession format. Should start with PXD');
                return;
            }

            showProgress();
            
            // Update upload section for PRIDE processing
            document.getElementById('progressText').innerHTML = `
                <div>Starting PRIDE dataset processing...</div>
                <div style="font-size: 0.8em; margin-top: 5px; color: #666;">
                    Fetching files from PRIDE database
                </div>
            `;
            document.getElementById('progressFill').style.width = '0%';

            fetch('/process-pride', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ accession: accession })
            })
            .then(response => response.json())
            .then(data => {
                if (data.job_id) {
                    currentJobId = data.job_id;
                    
                    // Update upload section to show PRIDE processing started
                    document.getElementById('progressText').innerHTML = `
                        <div>‚úÖ PRIDE processing initiated</div>
                        <div style="font-size: 0.8em; margin-top: 5px; color: #28a745;">
                            Job ID: ${data.job_id}
                        </div>
                    `;
                    document.getElementById('progressFill').style.width = '25%';
                    
                    pollPrideStatus(data.job_id);
                } else {
                    showError(data.error || 'PRIDE processing failed');
                }
            })
            .catch(error => {
                showError('PRIDE processing failed: ' + error.message);
            });
        }

        // Job status checking
        function checkStatus() {
            if (processingInProgress) return;
            
            const jobId = document.getElementById('jobId').value.trim();
            
            if (!jobId) {
                showError('Please enter a job ID');
                return;
            }

            showProgress();
            document.getElementById('progressText').textContent = 'Checking job status...';

            fetch(`/job-status/${jobId}`)
            .then(response => response.json())
            .then(data => {
                console.log('checkStatus received data:', data);
                console.log('checkStatus - console_output:', data.console_output);
                console.log('checkStatus - html_report_urls:', data.html_report_urls);
                
                if (data.error) {
                    showError(data.error);
                } else {
                    currentJobId = jobId;
                    
                    // Show processing sections if job is still running
                    if (data.status !== 'completed' && data.status !== 'failed') {
                        document.getElementById('processingProgressSection').style.display = 'block';
                        document.getElementById('consoleOutputSection').style.display = 'block';
                        document.getElementById('progressTitle').textContent = '‚öôÔ∏è Running PMultiQC Analysis...';
                        
                        // Start polling for updates
                        pollStatus(jobId);
                    } else {
                        // Job is already completed, show results directly
                        displayResults(data, jobId);
                    }
                }
            })
            .catch(error => {
                showError('Failed to check status: ' + error.message);
            });
        }

        // Poll status for file uploads
        function pollStatus(jobId) {
            let lastConsoleOutputLength = 0;
            let lastConsoleErrorsLength = 0;
            
            const interval = setInterval(() => {
                if (!processingInProgress) {
                    clearInterval(interval);
                    return;
                }
                
                fetch(`/job-status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Processing status:', data);
                    
                    // Update processing progress
                    if (data.progress !== undefined) {
                        const processingProgressFill = document.getElementById('processingProgressFill');
                        const processingProgressText = document.getElementById('processingProgressText');
                        
                        if (processingProgressFill && processingProgressText) {
                            processingProgressFill.style.width = data.progress + '%';
                            
                            let statusText = `Processing... ${data.progress}%`;
                            if (data.processing_stage) {
                                statusText = `${data.processing_stage} (${data.progress}%)`;
                            }
                            processingProgressText.textContent = statusText;
                        }
                    }
                    
                    // Update console output in real-time
                    updateConsoleOutput(data.console_output || [], data.console_errors || [], lastConsoleOutputLength, lastConsoleErrorsLength);
                    
                    // Update last lengths
                    lastConsoleOutputLength = (data.console_output || []).length;
                    lastConsoleErrorsLength = (data.console_errors || []).length;
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(interval);
                        processingInProgress = false;
                        
                        // Update title for completion
                        if (data.status === 'completed') {
                            document.getElementById('progressTitle').textContent = '‚úÖ Analysis Complete!';
                        } else {
                            document.getElementById('progressTitle').textContent = '‚ùå Analysis Failed';
                        }
                        
                        displayResults(data, jobId);
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    processingInProgress = false;
                    showError('Failed to check status: ' + error.message);
                });
            }, 1000);
        }
        
        function updateConsoleOutput(consoleOutput, consoleErrors, lastOutputLength, lastErrorsLength) {
            const consoleDiv = document.getElementById('consoleOutput');
            if (!consoleDiv) return;
            
            // Add new output lines
            const newOutputLines = consoleOutput.slice(lastOutputLength);
            const newErrorLines = consoleErrors.slice(lastErrorsLength);
            
            // Append new output lines
            newOutputLines.forEach(line => {
                if (line.trim()) {
                    const lineDiv = document.createElement('div');
                    lineDiv.style.margin = '2px 0';
                    lineDiv.style.color = '#2e8b57'; // Green for output
                    lineDiv.textContent = '> ' + line;
                    consoleDiv.appendChild(lineDiv);
                }
            });
            
            // Append new error lines
            newErrorLines.forEach(line => {
                if (line.trim()) {
                    const lineDiv = document.createElement('div');
                    lineDiv.style.margin = '2px 0';
                    lineDiv.style.color = '#dc3545'; // Red for errors
                    lineDiv.style.fontWeight = 'bold';
                    lineDiv.textContent = '! ' + line;
                    consoleDiv.appendChild(lineDiv);
                }
            });
            
            // Auto-scroll to bottom if there's new content
            if (newOutputLines.length > 0 || newErrorLines.length > 0) {
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
            
            // Show some initial text if console is empty
            if (consoleDiv.children.length === 0) {
                const placeholderDiv = document.createElement('div');
                placeholderDiv.style.color = '#6c757d';
                placeholderDiv.style.fontStyle = 'italic';
                placeholderDiv.textContent = 'Waiting for pmultiqc output...';
                consoleDiv.appendChild(placeholderDiv);
            }
        }

        // Poll status for PRIDE processing
        function pollPrideStatus(jobId) {
            let lastConsoleOutputLength = 0;
            let lastConsoleErrorsLength = 0;
            
            // Show processing sections for PRIDE processing
            document.getElementById('processingProgressSection').style.display = 'block';
            document.getElementById('consoleOutputSection').style.display = 'block';
            document.getElementById('progressTitle').textContent = '‚öôÔ∏è Running PMultiQC Analysis...';
            
            const interval = setInterval(() => {
                if (!processingInProgress) {
                    clearInterval(interval);
                    return;
                }
                
                fetch(`/job-status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('PRIDE processing status:', data);
                    
                    // Update processing progress
                    if (data.progress !== undefined) {
                        const processingProgressFill = document.getElementById('processingProgressFill');
                        const processingProgressText = document.getElementById('processingProgressText');
                        
                        if (processingProgressFill && processingProgressText) {
                            processingProgressFill.style.width = data.progress + '%';
                            
                            let statusText = `Processing... ${data.progress}%`;
                            if (data.processing_stage) {
                                statusText = `${data.processing_stage} (${data.progress}%)`;
                            }
                            processingProgressText.textContent = statusText;
                        }
                        
                        // Also update the main progress bar for PRIDE
                        document.getElementById('progressFill').style.width = data.progress + '%';
                        document.getElementById('progressText').textContent = `Processing PRIDE dataset... ${data.progress}%`;
                    }
                    
                    // Update console output in real-time
                    updateConsoleOutput(data.console_output || [], data.console_errors || [], lastConsoleOutputLength, lastConsoleErrorsLength);
                    
                    // Update last lengths
                    lastConsoleOutputLength = (data.console_output || []).length;
                    lastConsoleErrorsLength = (data.console_errors || []).length;
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(interval);
                        processingInProgress = false;
                        
                        console.log('PRIDE job completed, final data:', data);
                        console.log('PRIDE html_report_urls:', data.html_report_urls);
                        console.log('PRIDE console_output length:', data.console_output ? data.console_output.length : 'undefined/null');
                        
                        // Update title for completion
                        if (data.status === 'completed') {
                            document.getElementById('progressTitle').textContent = '‚úÖ Analysis Complete!';
                        } else {
                            document.getElementById('progressTitle').textContent = '‚ùå Analysis Failed';
                        }
                        
                        displayResults(data, jobId);
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    processingInProgress = false;
                    showError('Failed to check status: ' + error.message);
                });
            }, 1000);
        }

        // Display results
        function displayResults(data, jobId) {
            console.log('displayResults called with data:', data);
            console.log('displayResults - console_output:', data.console_output);
            console.log('displayResults - console_errors:', data.console_errors);
            console.log('displayResults - html_report_urls:', data.html_report_urls);
            console.log('displayResults - results:', data.results);
            const resultDiv = document.getElementById('result');
            
            if (data.status === 'completed') {
                let resultHtml = `
                    <h4>‚úÖ Processing Complete!</h4>
                    <p><strong>Job ID:</strong></p>
                    ${createJobIdElement(jobId)}
                    <p><strong>Input Type:</strong> ${data.input_type || 'Unknown'}</p>
                    ${data.accession ? `<p><strong>PRIDE Accession:</strong> ${data.accession}</p>` : ''}
                    ${data.files_processed ? `<p><strong>Files Processed:</strong> ${data.files_processed}/${data.total_files}</p>` : ''}
                    ${data.files_downloaded ? `<p><strong>Files Downloaded:</strong> ${data.files_downloaded}</p>` : ''}
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Finished at:</strong> ${data.finished_at}</p>
                `;

                // Add console output if available
                console.log('Console output check:', data.console_output ? data.console_output.length : 'undefined/null');
                if (data.console_output && data.console_output.length > 0) {
                    resultHtml += `
                        <details open style="margin: 15px 0;">
                            <summary style="cursor: pointer; color: #007bff; font-weight: bold;">üìã View Console Output (${data.console_output.length} lines)</summary>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef;">
                                ${data.console_output.map(line => `<div style="margin: 2px 0; color: #2e8b57;">${line}</div>`).join('')}
                            </div>
                        </details>
                    `;
                } else {
                    console.log('No console output available for completed job');
                }

                // Add individual file results if available
                console.log('Individual file results check:', data.results ? data.results.length : 'undefined/null');
                if (data.results && data.results.length > 0) {
                    resultHtml += `
                        <details open style="margin: 15px 0;">
                            <summary style="cursor: pointer; color: #007bff; font-weight: bold;">üìÅ Individual File Results (${data.results.length} files)</summary>
                            <div style="margin-top: 10px;">
                                ${data.results.map(result => `
                                    <div style="background: #e9ecef; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #007bff;">
                                        <strong>${result.file_name || 'Unknown file'}</strong> 
                                        <span style="color: #666;">(${result.input_type || 'Unknown type'})</span>
                                        ${result.status ? `<div style="margin-top: 5px; font-size: 0.9em;">Status: ${result.status}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    `;
                } else {
                    console.log('No individual file results available for completed job');
                }
                


                // Add download button
                resultHtml += `<a href="/download-report/${jobId}" class="download-btn">üì• Download Report</a>`;

                // Add HTML report URLs if available
                console.log('Checking html_report_urls:', data.html_report_urls);
                console.log('html_report_urls type:', typeof data.html_report_urls);
                console.log('html_report_urls keys:', data.html_report_urls ? Object.keys(data.html_report_urls) : 'N/A');
                if (data.html_report_urls && Object.keys(data.html_report_urls).length > 0) {
                    resultHtml += `
                        <div style="margin: 15px 0;">
                            <h5>üìä View Reports Online</h5>
                            ${Object.keys(data.html_report_urls).length === 1 ? 
                                `<a href="${data.html_report_urls[Object.keys(data.html_report_urls)[0]]}" class="download-btn online-report" target="_blank">üåê View Report Online</a>` :
                                `<div style="margin-bottom: 10px;">
                                    <label for="reportSelector" style="font-weight: bold; display: block; margin-bottom: 5px;">Select Report:</label>
                                    <select id="reportSelector" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin-right: 10px;">
                                        ${Object.entries(data.html_report_urls).map(([name, url], index) => 
                                            `<option value="${url}" ${index === 0 ? 'selected' : ''}>${name}</option>`
                                        ).join('')}
                                    </select>
                                    <button class="download-btn online-report" onclick="viewSelectedReport()">üåê View Report Online</button>
                                </div>`
                            }
                        </div>
                    `;
                }

                resultHtml += `<button class="return-home-btn" onclick="returnToHome()">‚Üê Return to Home</button>`;
                resultDiv.className = 'result success';
                resultDiv.innerHTML = resultHtml;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>‚ùå Processing Failed</h4>
                    <p><strong>Job ID:</strong></p>
                    ${createJobIdElement(jobId)}
                    <p><strong>Error:</strong> ${data.error || 'Unknown error'}</p>
                    <p><strong>Failed at:</strong> ${data.finished_at || 'Unknown'}</p>
                    <button class="return-home-btn" onclick="returnToHome()">‚Üê Return to Home</button>
                `;
            }
            
            resultDiv.style.display = 'block';
        }

        // Helper functions
        function createJobIdElement(jobId) {
            return `<div style="background: #e9ecef; padding: 8px; border-radius: 4px; font-family: monospace; margin: 10px 0; word-break: break-all;">${jobId}</div>`;
        }

        function debugJobStatus() {
            const jobId = document.getElementById('jobId').value.trim();
            
            if (!jobId) {
                showError('Please enter a job ID');
                return;
            }

            fetch(`/job-status/${jobId}`)
            .then(response => response.json())
            .then(data => {
                console.log('=== DEBUG JOB STATUS ===');
                console.log('Full response:', data);
                console.log('Status:', data.status);
                console.log('Console output length:', data.console_output ? data.console_output.length : 'undefined');
                console.log('Console errors length:', data.console_errors ? data.console_errors.length : 'undefined');
                console.log('HTML report URLs:', data.html_report_urls);
                console.log('Results:', data.results);
                console.log('Input type:', data.input_type);
                console.log('Accession:', data.accession);
                console.log('=== END DEBUG ===');
                
                // Show debug info in result area
                const resultDiv = document.getElementById('result');
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h4>üîç Debug Information</h4>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">
${JSON.stringify(data, null, 2)}
                    </pre>
                    <button class="return-home-btn" onclick="returnToHome()">‚Üê Return to Home</button>
                `;
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                showError('Debug failed: ' + error.message);
            });
        }

        function showError(message) {
            processingInProgress = false;
            currentUploadXhr = null;
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `<h4>‚ùå Error</h4><p>${message}</p><button class="return-home-btn" onclick="returnToHome()">‚Üê Return to Home</button>`;
            resultDiv.style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('cancelUploadBtn').style.display = 'none';
            
            // Hide processing sections
            document.getElementById('processingProgressSection').style.display = 'none';
            document.getElementById('consoleOutputSection').style.display = 'none';
            
            // Update title
            document.getElementById('progressTitle').textContent = '‚ùå Error Occurred';
        }

        // Report modal functions
        function showPrideReport(url) {
            const modal = document.getElementById('reportModal');
            const iframe = document.getElementById('reportIframe');
            const loading = document.getElementById('reportLoading');
            
            modal.style.display = 'block';
            loading.style.display = 'block';
            iframe.style.display = 'none';
            iframe.src = url;
        }

        function showSelectedReport() {
            const selector = document.getElementById('reportSelector');
            const url = selector.value;
            showPrideReport(url);
        }

        function viewSelectedReport() {
            const selector = document.getElementById('reportSelector');
            const url = selector.value;
            window.open(url, '_blank');
        }

        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            const iframe = document.getElementById('reportIframe');
            
            modal.style.display = 'none';
            iframe.src = '';
        }

        function hideLoading() {
            const loading = document.getElementById('reportLoading');
            const iframe = document.getElementById('reportIframe');
            
            loading.style.display = 'none';
            iframe.style.display = 'block';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeReportModal();
            }
        }
    </script>
</body>
</html> 