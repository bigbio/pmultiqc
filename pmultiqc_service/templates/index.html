<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pmultiqc - Proteomics MultiQC Analysis</title>
    <link rel="stylesheet" href="{{ config.BASE_URL.rstrip('/') }}/static/style.css">
    <link rel="stylesheet" href="{{ config.BASE_URL.rstrip('/') }}/static/components.css">
    <!-- TUS Resumable Upload Library -->
    <script src="https://cdn.jsdelivr.net/npm/tus-js-client@latest/dist/tus.min.js"></script>
    <script>
        // Global configuration - can be overridden by environment
        window.APP_CONFIG = {
            BASE_URL: '{{ config.BASE_URL.rstrip("/") }}',
            API_BASE: '{{ config.BASE_URL.rstrip("/") }}'
        };
    
        // Normalize and build API URL safely
        function getApiUrl(endpoint) {
            const base = String(window.APP_CONFIG.API_BASE || '').replace(/\/+$/, '');
            const path = String(endpoint || '').replace(/^\/+/, '');
            return `${base}/${path}`;
        }
        
        // Function to get full URL for static assets
        function getAssetUrl(asset) {
            return `${window.APP_CONFIG.BASE_URL}/static/${asset}`;
        }
        
        // Define hideLoading function early to avoid reference errors
        function hideLoading() {
            const loading = document.getElementById('reportLoading');
            const iframe = document.getElementById('reportIframe');
            if (loading && iframe) {
                loading.style.display = 'none';
                iframe.style.display = 'block';
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="logo">pmultiqc</div>
        <div class="subtitle">Proteomics MultiQC Analysis</div>

        <!-- Step 1: Choose Analysis Type -->
        <div id="step1" class="step active">
            <h3>üîç Choose Analysis Type</h3>
            <p>Select how you want to analyze your proteomics data</p>
            <button class="upload-btn" onclick="showStep('upload')">üìÅ Upload Files</button>
            {% if config.PRIDE_BUTTON_VISIBLE %}
            <button class="upload-btn" onclick="showStep('pride')">üîç PRIDE Dataset</button>
            {% endif %}
            <button class="upload-btn" onclick="showStep('lookup')">üîç Check Job Status</button>
        </div>

        <!-- Step 2: File Upload -->
        <div id="step2-upload" class="step">
            <h3>üìÅ Upload Files</h3>
            <p>Upload your proteomics data files as ZIP archives (containing MaxQuant, DIANN, quantms, or mzIdentML data)</p>
            <input type="file" id="fileInput" class="file-input" multiple accept=".zip">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose Files</button>
            <div id="fileList"></div>
            <button class="return-home-btn" onclick="returnToHome()">‚Üê Back to Home</button>
        </div>

        <!-- Step 3: PRIDE Dataset -->
        <div id="step2-pride" class="step">
            <h3>üîç PRIDE Dataset Analysis</h3>
            <p>Analyze public PRIDE datasets by entering the accession number</p>
            <input type="text" id="prideAccession" class="pride-input" placeholder="Enter PRIDE accession (e.g., PXD003133)" maxlength="20">
            <div style="text-align: center; margin-top: 8px;">
                <a href="#" onclick="showExamples()" style="color: #007bff; text-decoration: none; font-size: 14px;">View Examples</a>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="process-btn" onclick="processPrideDataset()">Process PRIDE Dataset</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="return-home-btn" onclick="returnToHome()">‚Üê Back to Home</button>
            </div>
        </div>

        <!-- Step 3: Job Lookup -->
        <div id="step2-lookup" class="step">
            <h3>üîç Check Job Status</h3>
            <p>Enter a job ID to check the status of a previous analysis or view completed results</p>
            <input type="text" id="jobIdInput" class="pride-input" placeholder="Enter Job ID (e.g., 550e8400-e29b-41d4-a716-446655440000)" maxlength="50">
            <div style="text-align: center; margin-top: 8px;">
                <p style="color: #666; font-size: 14px; margin: 0;">Job IDs are provided when you start an analysis</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="process-btn" onclick="checkJobStatus()">Check Job Status</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="return-home-btn" onclick="returnToHome()">‚Üê Back to Home</button>
            </div>
        </div>

        <!-- Step 4: Progress -->
        <div id="step5" class="step">
            <h3 id="progressTitle">‚è≥ Processing...</h3>
            
            <!-- Upload Progress Section -->
            <div id="uploadProgressSection" style="margin-bottom: 20px;">
                <h4 style="color: #495057; margin-bottom: 10px;">üìÅ File Upload</h4>
                <div id="progressContainer" class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" class="progress-text">Starting processing...</div>
                    <div style="margin-top: 15px;">
                        <button id="resumeUploadBtn" class="upload-btn" style="display: none;" onclick="resumeUpload()">‚ñ∂Ô∏è Resume Upload</button>
                        <button id="cancelUploadBtn" class="return-home-btn" style="display: none;" onclick="cancelUpload()">‚ùå Cancel Upload</button>
                    </div>
                </div>
            </div>
            
            <!-- Processing Progress Section -->
            <div id="processingProgressSection" style="display: none; margin-bottom: 20px;">
                <h4 style="color: #495057; margin-bottom: 10px;">‚öôÔ∏è pmultiqc Analysis</h4>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="processingProgressFill" class="progress-fill" style="background: linear-gradient(45deg, #28a745, #20c997);"></div>
                    </div>
                    <div id="processingProgressText" class="progress-text">Starting pmultiqc analysis...</div>
                </div>
            </div>
            
            <!-- Console Output Section -->
            <div id="consoleOutputSection" style="display: none;">
                <h4 style="color: #495057; margin-bottom: 10px;">üìã Console Output</h4>
                <div id="consoleOutput" style="
                    background: #f8f9fa; 
                    border: 1px solid #e9ecef; 
                    border-radius: 8px; 
                    padding: 15px; 
                    font-family: 'Courier New', monospace; 
                    font-size: 12px; 
                    max-height: 300px; 
                    overflow-y: auto; 
                    white-space: pre-wrap; 
                    color: #333;
                    line-height: 1.4;
                "></div>
            </div>
        </div>

        <!-- Results -->
        <div id="result" class="result"></div>

        <!-- pmultiqc Information Footer -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); margin-top: 40px; padding: 30px; border-top: 3px solid #007bff; border-radius: 0 0 15px 15px; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto;">
            <div style="text-align: center;">
            <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">About pmultiqc</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 25px; font-size: 1.1em;">
                <strong>pmultiqc</strong> is a MultiQC plugin for comprehensive quality control reporting of proteomics data. 
                It generates interactive HTML reports with visualizations and metrics to help you assess the quality of 
                your mass spectrometry-based proteomics experiments.
            </p>
            
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                <a href="https://pmultiqc.quantms.org" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #007bff, #0056b3); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,123,255,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üåê Project Website
                </a>
                
                <a href="https://github.com/bigbio/pmultiqc" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #28a745, #20c997); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(40,167,69,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üìÇ GitHub Repository
                </a>
                
                <a href="https://pmultiqc.quantms.org/#-example-reports" target="_blank" style="
                    display: inline-block; 
                    padding: 12px 25px; 
                    background: linear-gradient(45deg, #6f42c1, #5a32a3); 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(111,66,193,0.3)'" 
                   onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    üìä Example Reports
                </a>
            </div>
            
            <div style="border-top: 1px solid #dee2e6; padding-top: 20px;">
                <p style="color: #6c757d; font-size: 0.9em; margin: 0;">
                    Powered by <strong>pmultiqc</strong> - A comprehensive proteomics quality control framework
                </p>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let processingInProgress = false;
        let currentUploadXhr = null;

        // Wizard navigation
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            // Show selected step
            if (step === 'upload') {
                document.getElementById('step2-upload').classList.add('active');
            } else if (step === 'pride') {
                document.getElementById('step2-pride').classList.add('active');
            } else if (step === 'lookup') {
                document.getElementById('step2-lookup').classList.add('active');
            }
        }

        function showProgress() {
            processingInProgress = true;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step5').classList.add('active');
            document.getElementById('progressContainer').style.display = 'block';
        }

        function returnToHome() {
            processingInProgress = false;
            currentJobId = null;
            currentUploadXhr = null;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
            document.getElementById('result').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('cancelUploadBtn').style.display = 'none';
            
            // Reset progress sections
            document.getElementById('processingProgressSection').style.display = 'none';
            document.getElementById('consoleOutputSection').style.display = 'none';
            document.getElementById('progressTitle').textContent = '‚è≥ Processing...';
            document.getElementById('consoleOutput').innerHTML = '';
            
            // Reset progress bars
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('processingProgressFill').style.width = '0%';
            
            // Reset form fields
            document.getElementById('fileInput').value = '';
            document.getElementById('prideAccession').value = '';
            document.getElementById('fileList').innerHTML = '';
        }

        function resumeUpload() {
            if (currentUploadXhr && typeof currentUploadXhr.start === 'function') {
                console.log('üîÑ Manually resuming TUS upload...');
                
                // Hide error message
                document.getElementById('result').style.display = 'none';
                
                // Show progress container
                showProgress();
                
                // Update progress text
                const progressText = document.getElementById('progressText');
                progressText.innerHTML = 'üîÑ Resuming upload...';
                
                // Restart the upload (will resume from last offset)
                currentUploadXhr.start();
            }
        }
        
        function cancelUpload() {
            if (currentUploadXhr) {
                // TUS upload object has abort() method
                if (typeof currentUploadXhr.abort === 'function') {
                    currentUploadXhr.abort();
                }
                currentUploadXhr = null;
            }
            processingInProgress = false;
            document.getElementById('cancelUploadBtn').style.display = 'none';
            document.getElementById('resumeUploadBtn').style.display = 'none';
            showError('Upload cancelled by user');
        }

        // File upload functionality
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = e.target.files;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            for (let file of files) {
                const div = document.createElement('div');
                div.textContent = file.name;
                div.style.margin = '5px 0';
                div.style.padding = '5px';
                div.style.background = '#e9ecef';
                div.style.borderRadius = '4px';
                fileList.appendChild(div);
            }
            
            if (files.length > 0) {
                uploadFiles(files);
            }
        });

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond) {
            return formatBytes(bytesPerSecond) + '/s';
        }

        function formatTime(seconds) {
            if (!isFinite(seconds) || isNaN(seconds) || seconds <= 0) return 'calculating...';
            if (seconds < 60) return Math.round(seconds) + 's';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);
            return minutes + 'm ' + remainingSeconds + 's';
        }

        function uploadFiles(files) {
            if (processingInProgress) return;
            
            // TUS only uploads one file at a time
            const file = files[0];
            const totalSize = file.size;
            
            console.log(`üì§ Starting TUS upload: ${file.name} (${formatBytes(totalSize)})`);

            showProgress();
            
            // Initialize progress display
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            progressText.innerHTML = `Preparing to upload ${formatBytes(totalSize)}...`;
            progressFill.style.width = '0%';

            // Track upload timing and retries
            const startTime = Date.now();
            let lastLoaded = 0;
            let lastTime = startTime;
            let lastSuccessTime = startTime;
            let errorStartTime = null;
            
            // Show cancel button
            document.getElementById('cancelUploadBtn').style.display = 'inline-block';
            
            console.log(`‚è±Ô∏è Upload started at ${new Date().toLocaleTimeString()}.${Date.now() % 1000}`);
            
            // Create TUS upload with fingerprint for resume
            const upload = new tus.Upload(file, {
                endpoint: getApiUrl('/files/'),
                retryDelays: [0, 1000, 3000, 5000, 10000, 15000, 20000, 30000, 45000, 60000],  // More retries, up to 60s
                chunkSize: 50 * 1024 * 1024,  // 50 MB chunks
                // Enable resume by storing upload URL
                removeFingerprintOnSuccess: true,
                // Custom fingerprint based on file properties
                fingerprint: function(file, options) {
                    return Promise.resolve([
                        'tus',
                        file.name,
                        file.type,
                        file.size,
                        file.lastModified
                    ].join('-'));
                },
                metadata: {
                    filename: file.name,
                    filetype: file.type
                },
                onError: function(error) {
                    // Track when first error occurred
                    const currentTime = Date.now();
                    if (!errorStartTime) {
                        errorStartTime = currentTime;
                    }
                    const timeSinceLastSuccess = (currentTime - lastSuccessTime) / 1000;
                    
                    // onError is called AFTER all retries are exhausted
                    console.error(`‚ùå TUS upload failed after all retries at ${new Date().toLocaleTimeString()}.${currentTime % 1000}`);
                    console.log(`‚è±Ô∏è Time since last successful chunk: ${timeSinceLastSuccess.toFixed(1)}s`);
                    console.log('Error details:', JSON.stringify({
                        message: error.message,
                        hasOriginalResponse: !!error.originalResponse,
                        status: error.originalResponse ? error.originalResponse.getStatus() : 'no response'
                    }));
                    
                    // Check if this is a network error (resumable)
                    // Network errors typically have no response or response status 0
                    let isNetworkError = false;
                    if (!error.originalResponse) {
                        isNetworkError = true;
                    } else if (error.originalResponse && typeof error.originalResponse.getStatus === 'function') {
                        const status = error.originalResponse.getStatus();
                        isNetworkError = (status === 0 || status === undefined || status === null);
                    }
                    
                    console.log('Is network error?', isNetworkError);
                    
                    if (isNetworkError) {
                        console.log('üåê Network error - retries exhausted. Upload can be manually resumed.');
                        // Keep upload object alive for manual resume
                        currentUploadXhr = upload;
                        // Show error with Resume button
                        showError('‚ö†Ô∏è Upload paused due to network issue. Click "Resume Upload" to retry.', true);
                    } else {
                        // Non-network error - permanent failure
                        currentUploadXhr = null;
                        showError('Upload failed: ' + error.message, false);
                    }
                },
                onProgress: function(bytesUploaded, bytesTotal) {
                    const percentComplete = (bytesUploaded / bytesTotal) * 100;
                    const currentTime = Date.now();
                    const elapsed = (currentTime - startTime) / 1000; // seconds
                    
                    // Track last successful progress
                    lastSuccessTime = currentTime;
                    if (errorStartTime) {
                        const resumeDelay = (currentTime - errorStartTime) / 1000;
                        console.log(`‚úÖ Upload resumed after ${resumeDelay.toFixed(1)}s from first error`);
                        errorStartTime = null;
                    }
                    
                    // Update progress bar
                    progressFill.style.width = percentComplete + '%';
                    
                    // Calculate speed and ETA
                    let speedText = 'calculating...';
                    let etaText = 'calculating...';
                    
                    if (elapsed > 0.5 && bytesUploaded > 0) {
                        // Calculate instantaneous speed (for more responsive display)
                        const timeDiff = (currentTime - lastTime) / 1000;
                        const bytesDiff = bytesUploaded - lastLoaded;
                        const instantSpeed = timeDiff > 0 ? bytesDiff / timeDiff : 0;
                        
                        // Calculate average speed
                        const avgSpeed = bytesUploaded / elapsed;
                        
                        // Use weighted average: 70% instant, 30% average
                        const speed = instantSpeed * 0.7 + avgSpeed * 0.3;
                        
                        const remaining = bytesTotal - bytesUploaded;
                        const eta = speed > 0 ? remaining / speed : 0;
                        
                        speedText = formatSpeed(speed);
                        etaText = formatTime(eta);
                        
                        lastLoaded = bytesUploaded;
                        lastTime = currentTime;
                    }
                    
                    // Update progress text with detailed info
                    progressText.innerHTML = `
                        <div>Uploading: ${percentComplete.toFixed(1)}% complete (Resumable)</div>
                        <div style="font-size: 0.8em; margin-top: 5px;">
                            ${formatBytes(bytesUploaded)} / ${formatBytes(bytesTotal)} ‚Ä¢ 
                            ${speedText} ‚Ä¢ 
                            ETA: ${etaText}
                        </div>
                    `;
                    
                    // Log only at milestones: start, 25%, 50%, 75%, end
                    if (!window.lastLoggedPercent) window.lastLoggedPercent = -1;
                    const currPercent = Math.floor(percentComplete);
                    const milestones = [0, 25, 50, 75, 100];
                    const shouldLog = milestones.includes(currPercent) && currPercent !== window.lastLoggedPercent;
                    
                    if (shouldLog || percentComplete >= 99.9) {
                        console.log(`üìä TUS progress: ${percentComplete.toFixed(1)}% (${formatBytes(bytesUploaded)}/${formatBytes(bytesTotal)})`);
                        window.lastLoggedPercent = currPercent;
                    }
                },
                onSuccess: function() {
                    console.log('‚úÖ TUS upload completed successfully');
                    document.getElementById('cancelUploadBtn').style.display = 'none';
                    currentUploadXhr = null;
                    
                    const uploadTime = (Date.now() - startTime) / 1000;
                    
                    // Show upload complete message
                    progressText.innerHTML = `
                        <div>‚úÖ Upload completed in ${formatTime(uploadTime)}</div>
                        <div style="font-size: 0.8em; margin-top: 5px; color: #28a745;">
                            ${formatBytes(totalSize)} uploaded successfully ‚Ä¢ Processing...
                        </div>
                    `;
                    progressFill.style.width = '100%';
                    
                    // Show processing section
                    document.getElementById('processingProgressSection').style.display = 'block';
                    document.getElementById('consoleOutputSection').style.display = 'block';
                    
                    // Update title
                    document.getElementById('progressTitle').textContent = '‚öôÔ∏è Running pmultiqc Analysis...';
                    
                    // Get job_id from backend using filename
                    setTimeout(() => {
                        fetchJobIdByFilename(file.name);
                    }, 1000);
                }
            });
            
            // Store upload instance for cancellation
            currentUploadXhr = upload;
            
            // Listen for browser online event to help auto-resume
            const onlineHandler = function() {
                if (currentUploadXhr === upload) {
                    console.log('üåê Network back online - attempting to resume upload');
                    // TUS client will handle resume automatically via retries
                }
            };
            window.addEventListener('online', onlineHandler);
            
            // Start the upload
            upload.start();
        }
        
        // Fetch job_id by filename after TUS upload completes
        function fetchJobIdByFilename(filename, attempts = 0) {
            if (attempts > 10) {
                showError('Could not find processing job. Please check status manually.');
                return;
            }
            
            // Call backend endpoint to get job_id for this filename
            fetch(getApiUrl(`/tus-job/${encodeURIComponent(filename)}`))
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        // Job not ready yet, retry
                        throw new Error('Job not ready');
                    } else {
                        throw new Error('Failed to fetch job ID');
                    }
                })
                .then(data => {
                    if (data && data.job_id) {
                        console.log(`‚úÖ Found job_id: ${data.job_id}`);
                        currentJobId = data.job_id;
                        pollStatus(data.job_id);
                    } else {
                        throw new Error('No job_id in response');
                    }
                })
                .catch(error => {
                    if (attempts === 0 || attempts === 9) {
                        console.log(`üîÑ Fetching job_id (attempt ${attempts + 1}/10)...`);
                    }
                    // Retry after a short delay
                    setTimeout(() => fetchJobIdByFilename(filename, attempts + 1), 1000);
                });
        }

        // PRIDE dataset processing
        function processPrideDataset() {
            const accession = document.getElementById('prideAccession').value.trim().toUpperCase();
            
            if (!accession) {
                showError('Please enter a PRIDE accession number');
                return;
            }
            
            if (!accession.startsWith('PXD')) {
                showError('Invalid PRIDE accession format. Should start with PXD');
                return;
            }

            // Redirect to submit page with the accession
            window.location.href = `${window.APP_CONFIG.BASE_URL}/submit?accession=${accession}`;
        }

        function checkJobStatus() {
            const jobId = document.getElementById('jobIdInput').value.trim();
            
            if (!jobId) {
                showError('Please enter a job ID');
                return;
            }
            
            // Basic UUID format validation
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(jobId)) {
                showError('Invalid job ID format. Please enter a valid UUID.');
                return;
            }

            // Redirect to results page with the job ID
            window.location.href = `${window.APP_CONFIG.BASE_URL}/results?job=${jobId}`;
        }

        // Poll status for file uploads
        function pollStatus(jobId) {
            let lastConsoleOutputLength = 0;
            let lastConsoleErrorsLength = 0;
            
            const interval = setInterval(() => {
                if (!processingInProgress) {
                    clearInterval(interval);
                    return;
                }
                
                fetch(getApiUrl(`/job-status/${jobId}`))
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    // Only log status changes
                    if (data.status && data.status !== window.lastLoggedStatus) {
                        console.log(`üìã Job status: ${data.status} (${data.progress || 0}%)`);
                        window.lastLoggedStatus = data.status;
                    }
                    
                    // Update processing progress
                    if (data.progress !== undefined) {
                        const processingProgressFill = document.getElementById('processingProgressFill');
                        const processingProgressText = document.getElementById('processingProgressText');
                        
                        if (processingProgressFill && processingProgressText) {
                            processingProgressFill.style.width = data.progress + '%';
                            
                            let statusText = `Processing... ${data.progress}%`;
                            if (data.processing_stage) {
                                statusText = `${data.processing_stage} (${data.progress}%)`;
                            }
                            processingProgressText.textContent = statusText;
                        }
                    }
                    
                    // Update console output in real-time
                    updateConsoleOutput(data.console_output || [], data.console_errors || [], lastConsoleOutputLength, lastConsoleErrorsLength);
                    
                    // Update last lengths
                    lastConsoleOutputLength = (data.console_output || []).length;
                    lastConsoleErrorsLength = (data.console_errors || []).length;
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(interval);
                        processingInProgress = false;
                        
                        console.log('Job completed or failed. Status:', data.status);
                        console.log('Calling displayResults with jobId:', jobId);
                        console.log('About to call displayResults function...');
                        
                        // Update title for completion
                        if (data.status === 'completed') {
                            document.getElementById('progressTitle').textContent = '‚úÖ Analysis Complete!';
                        } else {
                            document.getElementById('progressTitle').textContent = '‚ùå Analysis Failed';
                        }
                        
                        console.log('Calling displayResults now...');
                        displayResults(data, jobId);
                        console.log('displayResults called successfully');
                    }
                })
                .catch(error => {
                    console.error('Error polling job status:', error);
                    // Don't immediately show error and return to home for temporary network issues
                    // Only clear interval and stop polling, but don't call showError
                    clearInterval(interval);
                    processingInProgress = false;
                    
                    // Log the error but don't redirect to home
                    console.log('Polling failed, but job might still be running. Error:', error.message);
                });
            }, 1000);
        }
        
        function updateConsoleOutput(consoleOutput, consoleErrors, lastOutputLength, lastErrorsLength) {
            const consoleDiv = document.getElementById('consoleOutput');
            if (!consoleDiv) return;
            
            // Add new output lines
            const newOutputLines = consoleOutput.slice(lastOutputLength);
            const newErrorLines = consoleErrors.slice(lastErrorsLength);
            
            // Append new output lines
            newOutputLines.forEach(line => {
                if (line.trim()) {
                    const lineDiv = document.createElement('div');
                    lineDiv.style.margin = '2px 0';
                    lineDiv.style.color = '#2e8b57'; // Green for output
                    lineDiv.textContent = '> ' + line;
                    consoleDiv.appendChild(lineDiv);
                }
            });
            
            // Append new error lines
            newErrorLines.forEach(line => {
                if (line.trim()) {
                    const lineDiv = document.createElement('div');
                    lineDiv.style.margin = '2px 0';
                    lineDiv.style.color = '#dc3545'; // Red for errors
                    lineDiv.style.fontWeight = 'bold';
                    lineDiv.textContent = '! ' + line;
                    consoleDiv.appendChild(lineDiv);
                }
            });
            
            // Auto-scroll to bottom if there's new content
            if (newOutputLines.length > 0 || newErrorLines.length > 0) {
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
            
            // Show some initial text if console is empty
            if (consoleDiv.children.length === 0) {
                const placeholderDiv = document.createElement('div');
                placeholderDiv.style.color = '#6c757d';
                placeholderDiv.style.fontStyle = 'italic';
                placeholderDiv.textContent = 'Waiting for pmultiqc output...';
                consoleDiv.appendChild(placeholderDiv);
            }
        }



        // Display results
        function displayResults(data, jobId) {
            console.log('=== DISPLAY RESULTS FUNCTION CALLED ===');
            console.log('displayResults called with data:', data);
            console.log('displayResults - console_output:', data.console_output);
            console.log('displayResults - console_errors:', data.console_errors);
            console.log('displayResults - html_report_urls:', data.html_report_urls);
            console.log('displayResults - results:', data.results);
            console.log('Job ID for redirect:', jobId);
            console.log('Base URL:', window.APP_CONFIG.BASE_URL);
            
            const redirectUrl = `${window.APP_CONFIG.BASE_URL}/results?job=${jobId}&t=${Date.now()}`;
            console.log('Redirecting to:', redirectUrl);
            console.log('Current location:', window.location.href);
            
            // Redirect to the results page instead of showing results inline
            try {
                console.log('Attempting redirect with window.location.replace...');
                window.location.replace(redirectUrl);
                console.log('Redirect command executed');
                
                // Add a timeout as backup in case the redirect doesn't work
                setTimeout(() => {
                    console.log('Backup redirect attempt...');
                    if (window.location.href !== redirectUrl) {
                        console.log('Redirect failed, trying window.location.assign...');
                        window.location.assign(redirectUrl);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error during redirect:', error);
                // Fallback: try using window.location.href
                console.log('Trying fallback redirect with window.location.href...');
                window.location.href = redirectUrl;
            }
        }

        // Helper functions
        function showError(message, showResumeButton = false) {
            processingInProgress = false;
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result error';
            
            // Build error HTML with optional Resume button
            let errorHtml = `<h4>‚ùå Error</h4><p>${message}</p>`;
            if (showResumeButton) {
                errorHtml += `<button class="upload-btn" onclick="resumeUpload()" style="margin-right: 10px;">‚ñ∂Ô∏è Resume Upload</button>`;
            }
            errorHtml += `<button class="return-home-btn" onclick="returnToHome()">‚Üê Return to Home</button>`;
            
            resultDiv.innerHTML = errorHtml;
            resultDiv.style.display = 'block';
            
            // For non-resumable errors, hide progress and clear upload
            if (!showResumeButton) {
                currentUploadXhr = null;
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('cancelUploadBtn').style.display = 'none';
                document.getElementById('resumeUploadBtn').style.display = 'none';
            }
            
            // Hide processing sections
            document.getElementById('processingProgressSection').style.display = 'none';
            document.getElementById('consoleOutputSection').style.display = 'none';
            
            // Update title
            document.getElementById('progressTitle').textContent = '‚ùå Error Occurred';
        }

        // Examples Modal
        function showExamples() {
            const modal = document.getElementById('examplesModal');
            modal.style.display = 'block';
        }

        function closeExamples() {
            const modal = document.getElementById('examplesModal');
            modal.style.display = 'none';
        }

        function selectExample(accession) {
            document.getElementById('prideAccession').value = accession;
            closeExamples();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('examplesModal');
            if (event.target === modal) {
                closeExamples();
            }
        }
    </script>

    <!-- Examples Modal -->
    <div id="examplesModal" class="modal" style="
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.5);
    ">
        <div class="modal-content" style="
            background-color: #fefefe; 
            margin: 5% auto; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 80%; 
            max-width: 600px; 
            border-radius: 10px;
            position: relative;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">üìã PRIDE Dataset Examples</h3>
                <span onclick="closeExamples()" style="
                    color: #aaa; 
                    font-size: 28px; 
                    font-weight: bold; 
                    cursor: pointer;
                ">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Here are some example PRIDE datasets you can analyze. Click on any example to automatically fill the accession field.
                </p>
            </div>

            <div style="display: grid; gap: 15px;">
                <!-- MaxQuant Example -->
                <div style="
                    border: 1px solid #e9ecef; 
                    border-radius: 8px; 
                    padding: 15px; 
                    background: #f8f9fa;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #333;">PXD003133 - MaxQuant Analysis</h4>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                A comprehensive MaxQuant analysis dataset with evidence.txt, peptides.txt, and proteinGroups.txt files.
                                This dataset demonstrates typical MaxQuant output structure and quality metrics.
                            </p>
                        </div>
                        <button onclick="selectExample('PXD003133')" style="
                            background: linear-gradient(45deg, #007bff, #0056b3); 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-size: 12px;
                        ">Use This Example</button>
                    </div>
                </div>

                <!-- DIANN Example -->
                <div style="
                    border: 1px solid #e9ecef; 
                    border-radius: 8px; 
                    padding: 15px; 
                    background: #f8f9fa;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #333;">PXD061709 - DIANN Analysis</h4>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                A DIANN search engine analysis dataset with report.tsv files. This dataset shows 
                                DIANN's output format and provides insights into peptide identification quality.
                            </p>
                        </div>
                        <button onclick="selectExample('PXD061709')" style="
                            background: linear-gradient(45deg, #28a745, #20c997); 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-size: 12px;
                        ">Use This Example</button>
                    </div>
                </div>

                <!-- DIANN Example 2 -->
                <div style="
                    border: 1px solid #e9ecef; 
                    border-radius: 8px; 
                    padding: 15px; 
                    background: #f8f9fa;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #333;">PXD039477 - MaxDIA Analysis</h4>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                A MaxDIA search engine analysis dataset with comprehensive proteomics data. 
                                This dataset provides additional examples of MaxDIA output format and analysis results.
                            </p>
                        </div>
                        <button onclick="selectExample('PXD039477')" style="
                            background: linear-gradient(45deg, #6f42c1, #5a32a3); 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-size: 12px;
                        ">Use This Example</button>
                    </div>
                </div>

                <!-- COMPLETE Example -->
                <div style="
                    border: 1px solid #e9ecef; 
                    border-radius: 8px; 
                    padding: 15px; 
                    background: #f8f9fa;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #333;">PXD051187 - COMPLETE Submission</h4>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                A COMPLETE submission containing mzIdentML files with associated peak lists (MGF/mzML). 
                                This dataset demonstrates the processing of compressed mzIdentML files and their corresponding peak list files.
                            </p>
                        </div>
                        <button onclick="selectExample('PXD051187')" style="
                            background: linear-gradient(45deg, #fd7e14, #e55a00); 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-size: 12px;
                        ">Use This Example</button>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button onclick="closeExamples()" style="
                    background: #6c757d; 
                    color: white; 
                    border: none; 
                    padding: 10px 20px; 
                    border-radius: 6px; 
                    cursor: pointer;
                ">Close</button>
            </div>
        </div>
    </div>
</body>
</html> 